name: Deploy to TEST Environment

on:
  push:
    branches:
      - main
    paths:
      - 'solutions/**'
  workflow_dispatch:
    inputs:
      solution_name:
        description: 'Solution name to deploy'
        required: true
        default: 'PharmaTrack360_Core'

jobs:
  deploy-to-test:
    runs-on: windows-latest
    environment: Test
    env:
      SOLUTION_NAME: ${{ github.event.inputs.solution_name || 'PharmaTrack360_Core' }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4.0.0
      with:
        token: ${{ secrets.PAT_TOKEN }}

    - name: Setup Power Platform CLI
      uses: microsoft/powerplatform-actions/actions-install@v1.0.0

    - name: Bump solution version
      id: bump_version
      shell: pwsh
      run: |
        $xmlPath = "solutions/${{ env.SOLUTION_NAME }}/src/Other/Solution.xml"
        [xml]$xml = Get-Content $xmlPath -Encoding UTF8
        $current = $xml.ImportExportXml.SolutionManifest.Version
        $parts = $current -split '\.'
        $parts[3] = [int]$parts[3] + 1
        $newVersion = $parts -join '.'
        $xml.ImportExportXml.SolutionManifest.Version = $newVersion
        $xml.Save((Resolve-Path $xmlPath))
        Write-Host "Version bumped: $current → $newVersion"
        echo "new_version=$newVersion" >> $env:GITHUB_OUTPUT

    - name: Commit version bump
      shell: pwsh
      run: |
        git config user.name "GitHub Actions Bot"
        git config user.email "actions@github.com"
        git add solutions/${{ env.SOLUTION_NAME }}/src/Other/Solution.xml
        $status = git status --porcelain
        if ($status) {
          git commit -m "chore: bump solution version to ${{ steps.bump_version.outputs.new_version }} [skip ci]"
          git push
        } else {
          Write-Host "No version change to commit."
        }

    - name: Import solution to TEST
      uses: microsoft/powerplatform-actions/import-solution@v1.0.0
      with:
        environment-url: ${{ secrets.TEST_ENVIRONMENT_URL }}
        app-id: ${{ secrets.TEST_CLIENT_ID }}
        client-secret: ${{ secrets.TEST_CLIENT_SECRET }}
        tenant-id: ${{ secrets.TENANT_ID }}
        solution-file: solutions/${{ env.SOLUTION_NAME }}/${{ env.SOLUTION_NAME }}_managed.zip
        force-overwrite: true
        publish-changes: true
        skip-dependency-check: false
        run-asynchronously: true
        max-async-wait-time: 60

    - name: Run Solution Checker
      uses: microsoft/powerplatform-actions/check-solution@v1.0.0
      with:
        environment-url: ${{ secrets.TEST_ENVIRONMENT_URL }}
        app-id: ${{ secrets.TEST_CLIENT_ID }}
        client-secret: ${{ secrets.TEST_CLIENT_SECRET }}
        tenant-id: ${{ secrets.TENANT_ID }}
        path: solutions/${{ env.SOLUTION_NAME }}/${{ env.SOLUTION_NAME }}_managed.zip
        checker-logs-artifact-name: solution-checker-logs

    - name: Upload Solution Checker Results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: solution-checker-results
        path: solution-checker-logs/

    - name: Send notification
      if: success()
      run: |
        echo "✅ Solution ${{ env.SOLUTION_NAME }} v${{ steps.bump_version.outputs.new_version }} deployed successfully to TEST environment"

    - name: Notify on failure
      if: failure()
      run: |
        echo "❌ Deployment of ${{ env.SOLUTION_NAME }} to TEST failed on run #${{ github.run_number }}"