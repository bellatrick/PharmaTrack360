name: Rollback to Previous Version

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to rollback'
        required: true
        type: choice
        options:
          - Test
          - Dev
      solution_name:
        description: 'Solution name to rollback'
        required: true
        default: 'PharmaTrack360_Core'
      backup_artifact:
        description: 'Backup artifact name (from a previous deployment run)'
        required: true

jobs:
  rollback:
    runs-on: windows-latest
    environment: ${{ github.event.inputs.environment }}
    env:
      ENV_UPPER: ${{ github.event.inputs.environment == 'Test' && 'TEST' || 'DEV' }}

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4.0.0

    - name: Setup Power Platform CLI
      uses: microsoft/powerplatform-actions/actions-install@v1.0.0

    - name: Download backup artifact
      uses: actions/download-artifact@v4
      with:
        name: ${{ github.event.inputs.backup_artifact }}
        path: rollback-artifact

    - name: List downloaded artifact contents
      shell: pwsh
      run: |
        Write-Host "Contents of rollback-artifact:"
        Get-ChildItem -Recurse rollback-artifact | Select-Object FullName

    - name: Locate solution zip
      id: find_zip
      shell: pwsh
      run: |
        $zip = Get-ChildItem -Path rollback-artifact -Filter "*.zip" -Recurse | Select-Object -First 1
        if (-not $zip) {
          Write-Error "No .zip file found in the downloaded artifact. Ensure the artifact contains a solution zip."
          exit 1
        }
        Write-Host "Found zip: $($zip.FullName)"
        echo "zip_path=$($zip.FullName)" >> $env:GITHUB_OUTPUT

    - name: Import backup solution to ${{ github.event.inputs.environment }}
      uses: microsoft/powerplatform-actions/import-solution@v1.0.0
      with:
        environment-url: ${{ github.event.inputs.environment == 'Test' && secrets.TEST_ENVIRONMENT_URL || secrets.DEV_ENVIRONMENT_URL }}
        app-id: ${{ github.event.inputs.environment == 'Test' && secrets.TEST_CLIENT_ID || secrets.DEV_CLIENT_ID }}
        client-secret: ${{ github.event.inputs.environment == 'Test' && secrets.TEST_CLIENT_SECRET || secrets.DEV_CLIENT_SECRET }}
        tenant-id: ${{ secrets.TENANT_ID }}
        solution-file: ${{ steps.find_zip.outputs.zip_path }}
        force-overwrite: true
        publish-changes: true
        skip-dependency-check: false
        run-asynchronously: true
        max-async-wait-time: 60

    - name: Notify on success
      if: success()
      run: |
        echo "✅ Rollback of ${{ github.event.inputs.solution_name }} to artifact '${{ github.event.inputs.backup_artifact }}' succeeded in ${{ github.event.inputs.environment }}"

    - name: Notify on failure
      if: failure()
      run: |
        echo "❌ Rollback failed for ${{ github.event.inputs.solution_name }} in ${{ github.event.inputs.environment }} — check the logs above"