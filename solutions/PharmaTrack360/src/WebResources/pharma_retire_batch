/**
 * Enable Rule for Deactivate Batches Button
 * Checks if the current view is "Expired Batches"
 * @param {Object} primaryControl - The primary control parameter from the Ribbon
 * @returns {boolean} - True if the button should be enabled/visible
 */
function DeactivateBatchesEnableRule(primaryControl) {
    if (!primaryControl) return false;

    // Get the view selector control
    var viewSelector = primaryControl.getViewSelector();

    // If view selector is available, check the current view Id/Name
    if (viewSelector) {
        var currentView = viewSelector.getCurrentView();

        // Check if currentView exists and name matches "Expired Batches"
        // Note: It's safer to compare IDs if possible, but Name was requested.
        if (currentView && currentView.name === "Expired Batches") {
            // Check if there are items in the view
            var grid = primaryControl.getGrid();

            if (grid) {
                var recordCount = grid.getTotalRecordCount();
                if (recordCount > 0) {
                    return true;
                }
            }
        }
    }

    return false;
}

/**
 * Action execution for Deactivate Batches Button
 * Deactivates selected "pharma_inventorybatches" records
 * @param {Object} primaryControl - The primary control parameter from the Ribbon
 */
function DeactivateBatchesAction(primaryControl) {
    if (!primaryControl) return;

    var selection = [];

    if (primaryControl.getGrid) {
         // It's a grid context (e.g. valid for standard grid buttons)
         var grid = primaryControl.getGrid();
         selection = grid.getSelectedRows();
    } else if (primaryControl.view && primaryControl.view.getSelection) {
        // Modern approach
        var viewSelection = primaryControl.view.getSelection();
        selection = viewSelection.getSelectedRows();
    }

    if (!selection || selection.length === 0) {
        Xrm.Navigation.openAlertDialog({ text: "Please select at least one batch to deactivate." });
        return;
    }

    var deactivatedNames = [];
    var updatePromises = [];

    selection.forEach(function(row) {
        var data = row.getData();
        var entity = data.getEntity();
        var entityId = entity.getId().replace('{', '').replace('}', '');
        var entityName = "pharma_inventorybatches";

        // Try to get a meaningful name for the email.
        // Primary attribute value is usually available in the reference.
        var name = entity.getPrimaryAttributeValue();
        if (name) {
            deactivatedNames.push(name);
        } else {
            deactivatedNames.push(entityId);
        }

        var dataToUpdate = {
            "statecode": 1, // Inactive
            "statuscode": 2 // Inactive
        };

        var updatePromise = Xrm.WebApi.updateRecord(entityName, entityId, dataToUpdate);
        updatePromises.push(updatePromise);
    });

    Promise.all(updatePromises).then(
        function(results) {
             // Refresh the grid
             primaryControl.refresh();

             // 1. Prepare Notification Details
             var messageDetails = "Deactivated " + results.length + " batches: " + deactivatedNames.join(", ");

             // 2. Prepare Custom API Request
             var request = {
                 NotificationDetails: messageDetails, // Matches the parameter defined in Dataverse
                 getMetadata: function() {
                     return {
                         boundParameter: null,
                         parameterTypes: {
                             "NotificationDetails": {
                                 "typeName": "Edm.String",
                                 "structuralProperty": 1
                             }
                         },
                         operationType: 0, // 0 = Action
                         operationName: "pharma_SendBatchNotification"
                     };
                 }
             };

             // 3. Call Custom API
             Xrm.WebApi.online.execute(request).then(
                 function(result) {
                     var alertStrings = { text: "Deactivated " + results.length + " batches and sent notification." };
                     Xrm.Navigation.openAlertDialog(alertStrings, { height: 120, width: 260 });
                 },
                 function(error) {
                     // Deactivation worked, but email failed
                     Xrm.Navigation.openErrorDialog({ message: "Batches deactivated, but email failed: " + error.message });
                 }
             );
        },
        function(error) {
             Xrm.Navigation.openErrorDialog({ message: "Error deactivating batches: " + error.message });
        }
    );
}
